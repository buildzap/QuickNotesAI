<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recurring Task Sync Debug</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .debug-section {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .debug-info {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .status-info { background-color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1><i class="bi bi-bug me-2"></i>Recurring Task Sync Debug</h1>
        <p class="text-muted">Debug and test recurring task calendar sync functionality</p>

        <!-- Status Overview -->
        <div class="debug-section">
            <h3><i class="bi bi-info-circle me-2"></i>System Status</h3>
            <div id="systemStatus">
                <div class="mb-2">
                    <span class="status-indicator status-info"></span>
                    <span>Loading system status...</span>
                </div>
            </div>
        </div>

        <!-- Test Controls -->
        <div class="debug-section">
            <h3><i class="bi bi-play-circle me-2"></i>Test Controls</h3>
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-primary mb-2" onclick="testCreateRecurringTask()">
                        <i class="bi bi-plus-circle me-2"></i>Create Test Recurring Task
                    </button>
                    <button class="btn btn-success mb-2" onclick="testSyncToCalendar()">
                        <i class="bi bi-calendar-plus me-2"></i>Test Sync to Calendar
                    </button>
                    <button class="btn btn-info mb-2" onclick="testModalDisplay()">
                        <i class="bi bi-window me-2"></i>Test Modal Display
                    </button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-warning mb-2" onclick="checkGoogleCalendar()">
                        <i class="bi bi-calendar-check me-2"></i>Check Google Calendar
                    </button>
                    <button class="btn btn-secondary mb-2" onclick="refreshStatus()">
                        <i class="bi bi-arrow-clockwise me-2"></i>Refresh Status
                    </button>
                    <button class="btn btn-danger mb-2" onclick="clearDebugLog()">
                        <i class="bi bi-trash me-2"></i>Clear Log
                    </button>
                </div>
            </div>
        </div>

        <!-- Debug Log -->
        <div class="debug-section">
            <h3><i class="bi bi-terminal me-2"></i>Debug Log</h3>
            <div id="debugLog" class="debug-info" style="max-height: 400px; overflow-y: auto;">
                Debug log will appear here...
            </div>
        </div>

        <!-- Task List -->
        <div class="debug-section">
            <h3><i class="bi bi-list-task me-2"></i>Recurring Tasks</h3>
            <div id="recurringTasksList">
                <div class="text-muted">Loading recurring tasks...</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/firebase.js"></script>
    <script src="js/gcal.js"></script>
    <script src="js/task.js"></script>

    <script>
        let debugLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
            debugLog.push(logEntry);
            
            const debugLogElement = document.getElementById('debugLog');
            if (debugLogElement) {
                debugLogElement.textContent = debugLog.join('\n');
                debugLogElement.scrollTop = debugLogElement.scrollHeight;
            }
            
            console.log(logEntry);
        }

        function clearDebugLog() {
            debugLog = [];
            document.getElementById('debugLog').textContent = 'Debug log cleared...';
        }

        function updateSystemStatus() {
            const statusElement = document.getElementById('systemStatus');
            const status = [];

            // Check Firebase
            if (window.firebaseDb && window.firebaseAuth) {
                status.push('<span class="status-indicator status-success"></span><span>Firebase: Connected</span>');
            } else {
                status.push('<span class="status-indicator status-error"></span><span>Firebase: Not Connected</span>');
            }

            // Check Google Calendar
            if (window.gcal) {
                status.push('<span class="status-indicator status-success"></span><span>Google Calendar: Available</span>');
                if (window.gcal.isSignedIn && window.gcal.isSignedIn()) {
                    status.push('<span class="status-indicator status-success"></span><span>Google Calendar: Signed In</span>');
                } else {
                    status.push('<span class="status-indicator status-warning"></span><span>Google Calendar: Not Signed In</span>');
                }
            } else {
                status.push('<span class="status-indicator status-error"></span><span>Google Calendar: Not Available</span>');
            }

            // Check User Role
            if (window.userRole === 'premium') {
                status.push('<span class="status-indicator status-success"></span><span>User Role: Premium</span>');
            } else {
                status.push('<span class="status-indicator status-warning"></span><span>User Role: ' + (window.userRole || 'Unknown') + '</span>');
            }

            // Check Task State
            if (window.taskState && window.taskState.tasks) {
                const recurringTasks = window.taskState.tasks.filter(t => t.recurring);
                status.push('<span class="status-indicator status-info"></span><span>Recurring Tasks: ' + recurringTasks.length + '</span>');
            } else {
                status.push('<span class="status-indicator status-warning"></span><span>Task State: Not Available</span>');
            }

            statusElement.innerHTML = status.map(s => '<div class="mb-2">' + s + '</div>').join('');
        }

        function updateRecurringTasksList() {
            const listElement = document.getElementById('recurringTasksList');
            
            if (!window.taskState || !window.taskState.tasks) {
                listElement.innerHTML = '<div class="text-muted">Task state not available</div>';
                return;
            }

            const recurringTasks = window.taskState.tasks.filter(t => t.recurring);
            
            if (recurringTasks.length === 0) {
                listElement.innerHTML = '<div class="text-muted">No recurring tasks found</div>';
                return;
            }

            const taskHtml = recurringTasks.map(task => `
                <div class="card mb-2">
                    <div class="card-body">
                        <h6 class="card-title">${task.title}</h6>
                        <p class="card-text">
                            <small class="text-muted">
                                ID: ${task.id}<br>
                                Recurrence: ${task.recurrence ? JSON.stringify(task.recurrence) : 'No recurrence data'}<br>
                                Status: ${task.status}<br>
                                Priority: ${task.priority}
                            </small>
                        </p>
                        <button class="btn btn-sm btn-primary" onclick="testSyncSpecificTask('${task.id}', '${task.title}')">
                            <i class="bi bi-calendar-plus me-1"></i>Test Sync
                        </button>
                    </div>
                </div>
            `).join('');

            listElement.innerHTML = taskHtml;
        }

        async function testCreateRecurringTask() {
            try {
                log('Creating test recurring task...', 'info');
                
                if (!window.firebaseDb || !window.firebaseAuth) {
                    throw new Error('Firebase not available');
                }

                const user = window.firebaseAuth.currentUser;
                if (!user) {
                    throw new Error('User not authenticated');
                }

                const testTask = {
                    userId: user.uid,
                    title: 'Test Recurring Task - ' + new Date().toLocaleTimeString(),
                    description: 'This is a test recurring task for debugging',
                    dueDate: new Date(Date.now() + 24 * 60 * 60 * 1000), // Tomorrow
                    priority: 'medium',
                    status: 'in-progress',
                    tags: ['test', 'debug'],
                    inputMethod: 'manual',
                    recurring: true,
                    recurrence: {
                        type: 'daily',
                        time: '09:00',
                        nextDue: new Date(Date.now() + 24 * 60 * 60 * 1000)
                    },
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                const docRef = await window.firebaseDb.collection('tasks').add(testTask);
                log('Test recurring task created with ID: ' + docRef.id, 'success');
                
                // Refresh the task list
                setTimeout(() => {
                    updateRecurringTasksList();
                    updateSystemStatus();
                }, 1000);

            } catch (error) {
                log('Error creating test task: ' + error.message, 'error');
            }
        }

        async function testSyncToCalendar() {
            try {
                log('Testing sync to calendar...', 'info');
                
                if (!window.taskState || !window.taskState.tasks) {
                    throw new Error('No tasks available');
                }

                const recurringTasks = window.taskState.tasks.filter(t => t.recurring);
                if (recurringTasks.length === 0) {
                    throw new Error('No recurring tasks found');
                }

                const testTask = recurringTasks[0];
                log('Using test task: ' + testTask.title, 'info');
                
                // Test the sync function directly
                await syncRecurringTaskToGoogleCalendar(testTask.id, testTask.title);
                log('Sync test completed', 'success');

            } catch (error) {
                log('Error testing sync: ' + error.message, 'error');
            }
        }

        async function testSyncSpecificTask(taskId, taskTitle) {
            try {
                log('Testing sync for specific task: ' + taskTitle, 'info');
                await syncRecurringTaskToGoogleCalendar(taskId, taskTitle);
                log('Specific task sync test completed', 'success');
            } catch (error) {
                log('Error testing specific task sync: ' + error.message, 'error');
            }
        }

        async function testModalDisplay() {
            try {
                log('Testing modal display...', 'info');
                
                const testTask = {
                    id: 'test-modal-task',
                    title: 'Test Modal Task',
                    recurring: true,
                    recurrence: {
                        type: 'daily',
                        time: '09:00'
                    }
                };
                
                showSyncDurationModal(testTask, testTask.title);
                log('Modal display test completed', 'success');

            } catch (error) {
                log('Error testing modal: ' + error.message, 'error');
            }
        }

        async function checkGoogleCalendar() {
            try {
                log('Checking Google Calendar status...', 'info');
                
                if (!window.gcal) {
                    throw new Error('Google Calendar not available');
                }

                log('Google Calendar object found', 'success');
                log('Available methods: ' + Object.keys(window.gcal).join(', '), 'info');

                if (window.gcal.isSignedIn && typeof window.gcal.isSignedIn === 'function') {
                    const isSignedIn = window.gcal.isSignedIn();
                    log('Sign-in status: ' + (isSignedIn ? 'Signed In' : 'Not Signed In'), isSignedIn ? 'success' : 'warning');
                } else {
                    log('Sign-in check not available', 'warning');
                }

                if (window.gcal.createRecurringEvent) {
                    log('createRecurringEvent function available', 'success');
                } else {
                    log('createRecurringEvent function not available', 'error');
                }

            } catch (error) {
                log('Error checking Google Calendar: ' + error.message, 'error');
            }
        }

        function refreshStatus() {
            log('Refreshing status...', 'info');
            updateSystemStatus();
            updateRecurringTasksList();
        }

        // Initialize debug page
        document.addEventListener('DOMContentLoaded', function() {
            log('Debug page loaded', 'info');
            
            // Wait for Firebase and other dependencies to load
            setTimeout(() => {
                updateSystemStatus();
                updateRecurringTasksList();
                log('Initial status check completed', 'info');
            }, 2000);
        });

        // Override showToast to also log to debug
        const originalShowToast = window.showToast;
        window.showToast = function(message, type) {
            log('Toast: ' + message, type);
            if (originalShowToast) {
                originalShowToast(message, type);
            }
        };
    </script>
</body>
</html> 